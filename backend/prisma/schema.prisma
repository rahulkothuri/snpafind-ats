generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

model Company {
  id           String   @id @default(uuid())
  name         String
  logoUrl      String?  @map("logo_url")
  contactEmail String   @map("contact_email")
  address      String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Enhanced company profile fields (Requirements 7.1, 7.2)
  website     String?
  companySize String? @map("company_size")
  industry    String?
  description String? @db.Text

  // Contact & Location
  phone      String?
  city       String?
  state      String?
  country    String?
  postalCode String? @map("postal_code")

  // Social Media Links
  linkedinUrl    String? @map("linkedin_url")
  twitterUrl     String? @map("twitter_url")
  facebookUrl    String? @map("facebook_url")
  careersPageUrl String? @map("careers_page_url")

  // Branding
  brandColor String? @default("#0b6cf0") @map("brand_color")

  users          User[]
  jobs           Job[]
  candidates     Candidate[]
  stageTemplates PipelineStageTemplate[]
  slaConfigs     SLAConfig[]
  tasks          Task[]

  // Phase 3 relations (Interview Management)
  emailTemplates     EmailTemplate[]
  scorecardTemplates ScorecardTemplate[]
  companySettings    CompanySettings?

  @@map("companies")
}

enum UserRole {
  admin
  hiring_manager
  recruiter
  vendor

  @@map("user_role")
}

model User {
  id           String   @id @default(uuid())
  companyId    String   @map("company_id")
  name         String
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         UserRole @default(recruiter)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  company               Company                 @relation(fields: [companyId], references: [id])
  assignedJobs          Job[]                   @relation("AssignedJobs")
  createdStageTemplates PipelineStageTemplate[]

  // Vendor job assignments (for vendor role)
  vendorJobAssignments VendorJobAssignment[] @relation("VendorAssignments")

  // Phase 2 relations
  stageHistoryMoves    StageHistory[]        @relation("StageHistoryMovedBy")
  candidateNotes       CandidateNote[]       @relation("CandidateNoteAuthor")
  candidateAttachments CandidateAttachment[] @relation("CandidateAttachmentUploader")
  notifications        Notification[]
  tasks                Task[]

  // Phase 3 relations (Interview Management)
  scheduledInterviews Interview[]         @relation("InterviewScheduler")
  interviewPanels     InterviewPanel[]
  interviewFeedback   InterviewFeedback[] @relation("FeedbackAuthor")
  calendarEvents      CalendarEvent[]     @relation("UserCalendarEvents")
  oauthTokens         OAuthToken[]

  @@map("users")
}

enum JobStatus {
  active
  paused
  closed

  @@map("job_status")
}

model Job {
  id         String @id @default(uuid())
  companyId  String @map("company_id")
  title      String
  department String

  // Experience range (Requirements 1.1, 1.2)
  experienceMin Float? @map("experience_min")
  experienceMax Float? @map("experience_max")

  // Salary range (Requirements 1.1, 1.3)
  salaryMin Float?  @map("salary_min")
  salaryMax Float?  @map("salary_max")
  variables String? // Incentives description

  // Requirements (Requirements 1.1)
  educationQualification String? @map("education_qualification")
  ageUpTo                Int?    @map("age_up_to")
  skills                 Json    @default("[]")
  preferredIndustry      String? @map("preferred_industry")

  // Work details (Requirements 1.1, 1.4, 1.5, 1.6)
  workMode  String? @map("work_mode")
  locations Json    @default("[]") // Array of cities (multi-select)
  priority  String? @default("Medium")
  jobDomain String? @map("job_domain")

  // Assignment (Requirements 1.1)
  assignedRecruiterId String? @map("assigned_recruiter_id")

  // Content
  description String? @db.Text

  // Mandatory Criteria - editable screening criteria for the job
  mandatoryCriteria Json? @default("{}") @map("mandatory_criteria")

  // Screening Questions - questions candidates must answer before applying
  screeningQuestions Json? @default("[]") @map("screening_questions")

  // Auto-rejection rules - automated rules for rejecting candidates
  autoRejectionRules Json? @default("{}") @map("auto_rejection_rules")

  // Existing fields
  status    JobStatus @default(active)
  openings  Int       @default(1)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Legacy fields (kept for compatibility)
  location       String?
  employmentType String? @map("employment_type")
  salaryRange    String? @map("salary_range")

  company           Company               @relation(fields: [companyId], references: [id])
  pipelineStages    PipelineStage[]
  jobCandidates     JobCandidate[]
  assignedRecruiter User?                 @relation("AssignedJobs", fields: [assignedRecruiterId], references: [id])
  vendorAssignments VendorJobAssignment[] @relation("JobVendors")

  @@index([companyId])
  @@index([assignedRecruiterId])
  @@index([companyId, assignedRecruiterId])
  @@index([status])
  @@map("jobs")
}

model PipelineStageTemplate {
  id          String   @id @default(uuid())
  name        String
  description String   @default("")
  stages      Json     @default("[]") // JSON array of PipelineStageConfig
  isPublic    Boolean  @default(false) @map("is_public")
  companyId   String   @map("company_id")
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator User    @relation(fields: [createdBy], references: [id])

  @@unique([companyId, name])
  @@index([companyId])
  @@index([createdBy])
  @@index([isPublic])
  @@map("pipeline_stage_templates")
}

model PipelineStage {
  id          String   @id @default(uuid())
  jobId       String   @map("job_id")
  name        String
  position    Int
  isDefault   Boolean  @default(false) @map("is_default")
  isMandatory Boolean  @default(false) @map("is_mandatory")
  parentId    String?  @map("parent_id") // For sub-stages (Requirements 4.1, 4.2, 4.3)
  createdAt   DateTime @default(now()) @map("created_at")

  job           Job             @relation(fields: [jobId], references: [id], onDelete: Cascade)
  parent        PipelineStage?  @relation("SubStages", fields: [parentId], references: [id], onDelete: Cascade)
  subStages     PipelineStage[] @relation("SubStages")
  jobCandidates JobCandidate[]
  stageHistory  StageHistory[]

  @@unique([jobId, position])
  @@map("pipeline_stages")
}

model Candidate {
  id              String  @id @default(uuid())
  companyId       String  @map("company_id")
  name            String
  email           String  @unique
  phone           String?
  experienceYears Float   @default(0) @map("experience_years")
  currentCompany  String? @map("current_company")
  location        String
  currentCtc      String? @map("current_ctc")
  expectedCtc     String? @map("expected_ctc")
  noticePeriod    String? @map("notice_period")
  source          String
  availability    String?
  skills          Json    @default("[]")
  resumeUrl       String? @map("resume_url")
  score           Int?

  // Score breakdown fields for detailed scoring
  domainScore              Int? @map("domain_score")
  industryScore            Int? @map("industry_score")
  keyResponsibilitiesScore Int? @map("key_responsibilities_score")

  // Enhanced fields for comprehensive candidate display
  age              Int?
  industry         String?
  jobDomain        String? @map("job_domain")
  candidateSummary String? @map("candidate_summary") @db.Text
  tags             Json    @default("[]")
  title            String? // Current job title
  department       String? // Current department
  internalMobility Boolean @default(false) @map("internal_mobility")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company       Company               @relation(fields: [companyId], references: [id])
  jobCandidates JobCandidate[]
  activities    CandidateActivity[]
  notes         CandidateNote[]
  attachments   CandidateAttachment[]

  @@map("candidates")
}

model JobCandidate {
  id             String   @id @default(uuid())
  jobId          String   @map("job_id")
  candidateId    String   @map("candidate_id")
  currentStageId String   @map("current_stage_id")
  appliedAt      DateTime @default(now()) @map("applied_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  job          Job                 @relation(fields: [jobId], references: [id], onDelete: Cascade)
  candidate    Candidate           @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  currentStage PipelineStage       @relation(fields: [currentStageId], references: [id])
  activities   CandidateActivity[]
  stageHistory StageHistory[]

  // Phase 3 relations (Interview Management)
  interviews Interview[]

  @@unique([jobId, candidateId])
  @@map("job_candidates")
}

enum ActivityType {
  stage_change
  note_added
  resume_uploaded
  interview_scheduled
  interview_rescheduled
  interview_cancelled
  interview_feedback
  score_updated

  @@map("activity_type")
}

model CandidateActivity {
  id             String       @id @default(uuid())
  candidateId    String       @map("candidate_id")
  jobCandidateId String?      @map("job_candidate_id")
  activityType   ActivityType @map("activity_type")
  description    String
  metadata       Json?
  createdAt      DateTime     @default(now()) @map("created_at")

  candidate    Candidate     @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  jobCandidate JobCandidate? @relation(fields: [jobCandidateId], references: [id], onDelete: Cascade)

  @@map("candidate_activities")
}

// Phase 2: Stage History - tracks time spent in each stage (Requirements 2.1, 2.2, 11.2)
model StageHistory {
  id             String    @id @default(uuid())
  jobCandidateId String    @map("job_candidate_id")
  stageId        String    @map("stage_id")
  stageName      String    @map("stage_name")
  enteredAt      DateTime  @default(now()) @map("entered_at")
  exitedAt       DateTime? @map("exited_at")
  durationHours  Float?    @map("duration_hours")
  comment        String?   @db.Text
  movedBy        String?   @map("moved_by")

  jobCandidate JobCandidate  @relation(fields: [jobCandidateId], references: [id], onDelete: Cascade)
  stage        PipelineStage @relation(fields: [stageId], references: [id])
  user         User?         @relation("StageHistoryMovedBy", fields: [movedBy], references: [id])

  @@index([jobCandidateId])
  @@index([stageId])
  @@map("stage_history")
}

// Phase 2: Candidate Notes (Requirements 6.1, 6.2)
model CandidateNote {
  id          String   @id @default(uuid())
  candidateId String   @map("candidate_id")
  content     String   @db.Text
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  author    User      @relation("CandidateNoteAuthor", fields: [createdBy], references: [id])

  @@index([candidateId])
  @@map("candidate_notes")
}

// Phase 2: Candidate Attachments (Requirements 6.4, 6.5)
model CandidateAttachment {
  id          String   @id @default(uuid())
  candidateId String   @map("candidate_id")
  fileName    String   @map("file_name")
  fileUrl     String   @map("file_url")
  fileType    String   @map("file_type")
  fileSize    Int      @map("file_size")
  uploadedBy  String   @map("uploaded_by")
  createdAt   DateTime @default(now()) @map("created_at")

  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  uploader  User      @relation("CandidateAttachmentUploader", fields: [uploadedBy], references: [id])

  @@index([candidateId])
  @@map("candidate_attachments")
}

// Phase 2: Notification Type Enum (Requirements 8.1, 11.1)
enum NotificationType {
  stage_change
  feedback_pending
  sla_breach
  interview_scheduled
  offer_pending

  @@map("notification_type")
}

// Phase 2: Notifications (Requirements 8.1, 11.1)
model Notification {
  id         String           @id @default(uuid())
  userId     String           @map("user_id")
  type       NotificationType
  title      String
  message    String
  entityType String?          @map("entity_type") // 'candidate', 'job', 'interview'
  entityId   String?          @map("entity_id")
  isRead     Boolean          @default(false) @map("is_read")
  createdAt  DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

// Phase 2: SLA Configuration (Requirements 10.5)
model SLAConfig {
  id            String   @id @default(uuid())
  companyId     String   @map("company_id")
  stageName     String   @map("stage_name")
  thresholdDays Int      @map("threshold_days")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, stageName])
  @@map("sla_configs")
}

// System-wide SLA Defaults (no company constraint)
model SystemSLADefault {
  id            String   @id @default(uuid())
  stageName     String   @unique @map("stage_name")
  thresholdDays Int      @map("threshold_days")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("system_sla_defaults")
}

// Task Type Enum
enum TaskType {
  feedback
  approval
  reminder
  pipeline

  @@map("task_type")
}

// Phase 3: Interview Mode Enum (Requirements 2.1)
enum InterviewMode {
  google_meet
  microsoft_teams
  in_person
  custom_url

  @@map("interview_mode")
}

// Phase 3: Interview Status Enum (Requirements 1.3, 8.5)
enum InterviewStatus {
  scheduled
  in_progress
  completed
  cancelled
  no_show

  @@map("interview_status")
}

// Phase 3: Interview Recommendation Enum (Requirements 9.4)
enum InterviewRecommendation {
  strong_hire
  hire
  no_hire
  strong_no_hire

  @@map("interview_recommendation")
}

// Task Severity Enum
enum TaskSeverity {
  high
  medium
  low

  @@map("task_severity")
}

// Task Status Enum
enum TaskStatus {
  open
  closed

  @@map("task_status")
}

// Tasks for dashboard task management
model Task {
  id          String       @id @default(uuid())
  companyId   String       @map("company_id")
  userId      String       @map("user_id")
  type        TaskType
  text        String
  severity    TaskSeverity @default(medium)
  status      TaskStatus   @default(open)
  completedAt DateTime?    @map("completed_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId, userId])
  @@index([status])
  @@map("tasks")
}

// Phase 3: Interview Model (Requirements 1.3, 1.4, 17.1)
model Interview {
  id             String          @id @default(uuid())
  jobCandidateId String          @map("job_candidate_id")
  scheduledAt    DateTime        @map("scheduled_at")
  duration       Int // minutes
  timezone       String          @default("UTC")
  mode           InterviewMode
  meetingLink    String?         @map("meeting_link")
  location       String?
  status         InterviewStatus @default(scheduled)
  notes          String?         @db.Text
  cancelReason   String?         @map("cancel_reason") @db.Text
  scheduledBy    String          @map("scheduled_by")
  roundType      String?         @map("round_type") // Interview round type (Technical, HR, etc.)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  jobCandidate   JobCandidate        @relation(fields: [jobCandidateId], references: [id], onDelete: Cascade)
  scheduler      User                @relation("InterviewScheduler", fields: [scheduledBy], references: [id])
  panelMembers   InterviewPanel[]
  feedback       InterviewFeedback[]
  calendarEvents CalendarEvent[]

  @@index([jobCandidateId])
  @@index([scheduledAt])
  @@index([status])
  @@map("interviews")
}

// Phase 3: Interview Panel - Many-to-Many: Interview <-> User (Requirements 1.2)
model InterviewPanel {
  id          String   @id @default(uuid())
  interviewId String   @map("interview_id")
  userId      String   @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")

  interview Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id])

  @@unique([interviewId, userId])
  @@map("interview_panels")
}

// Phase 3: Interview Feedback/Scorecard (Requirements 9.1, 9.5)
model InterviewFeedback {
  id              String                  @id @default(uuid())
  interviewId     String                  @map("interview_id")
  panelMemberId   String                  @map("panel_member_id")
  ratings         Json // Array of {criterion, score, comments}
  overallComments String                  @map("overall_comments") @db.Text
  recommendation  InterviewRecommendation
  submittedAt     DateTime                @default(now()) @map("submitted_at")

  interview   Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  panelMember User      @relation("FeedbackAuthor", fields: [panelMemberId], references: [id])

  @@unique([interviewId, panelMemberId])
  @@index([interviewId])
  @@map("interview_feedback")
}

// Phase 3: Calendar Event Sync Tracking (Requirements 4.2, 5.2)
model CalendarEvent {
  id          String   @id @default(uuid())
  interviewId String   @map("interview_id")
  userId      String   @map("user_id")
  provider    String // 'google' or 'microsoft'
  externalId  String   @map("external_id")
  createdAt   DateTime @default(now()) @map("created_at")

  interview Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  user      User      @relation("UserCalendarEvents", fields: [userId], references: [id])

  @@unique([interviewId, userId, provider])
  @@map("calendar_events")
}

// Phase 3: OAuth Token Storage (Requirements 4.1, 5.1)
model OAuthToken {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  provider     String // 'google' or 'microsoft'
  accessToken  String   @map("access_token") @db.Text
  refreshToken String?  @map("refresh_token") @db.Text
  expiresAt    DateTime @map("expires_at")
  scope        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@map("oauth_tokens")
}

// Phase 3: Email Template Storage (Requirements 16.1, 16.4)
model EmailTemplate {
  id          String   @id @default(uuid())
  companyId   String?  @map("company_id") // null = system default
  templateKey String   @map("template_key")
  subject     String
  htmlContent String   @map("html_content") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, templateKey])
  @@map("email_templates")
}

// Phase 3: Scorecard Template (Requirements 9.1)
model ScorecardTemplate {
  id        String   @id @default(uuid())
  companyId String   @map("company_id")
  name      String
  criteria  Json // Array of {name, description, weight}
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("scorecard_templates")
}

// Phase 3: Company Settings (Requirements 10.5)
model CompanySettings {
  id                        String   @id @default(uuid())
  companyId                 String   @unique @map("company_id")
  autoStageMovementEnabled  Boolean  @default(true) @map("auto_stage_movement_enabled")
  feedbackReminderHours     Int      @default(24) @map("feedback_reminder_hours")
  preferredCalendarProvider String?  @map("preferred_calendar_provider")
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("company_settings")
}

// Vendor Job Assignment - Many-to-Many: Vendor User <-> Job
model VendorJobAssignment {
  id        String   @id @default(uuid())
  vendorId  String   @map("vendor_id")
  jobId     String   @map("job_id")
  createdAt DateTime @default(now()) @map("created_at")

  vendor User @relation("VendorAssignments", fields: [vendorId], references: [id], onDelete: Cascade)
  job    Job  @relation("JobVendors", fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([vendorId, jobId])
  @@index([vendorId])
  @@index([jobId])
  @@map("vendor_job_assignments")
}
